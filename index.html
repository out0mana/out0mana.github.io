<html>
    <script src='https://d3js.org/d3.v5.min.js'></script>
    <script>
        var currentSlide = 1;
        var slideData = {};
        var gotData = false;
        function render(slide) {
            console.log(slide);
            document.getElementById(`${currentSlide}`).removeAttribute('style');
            document.getElementById(`${slide}`).style.border = '2px solid #008CBA';

            currentSlide = slide;
            d3.select('div').html("");
            var width = 500;
            var height = 500;
            var margin = 100;
            var svg = d3.select('div').append('svg').attr('width', width).attr('height', height);
            var x = d3.scaleTime().domain([new Date(2020,2,1), new Date()]).range([0, width - 2 * margin]);
            var y = d3.scaleLinear().domain([14102,0]).range([0, height - 2 * margin]);
            var colors = d3.scaleLinear().domain([0,237/2,237]).range(['green','yellow','red']);
            if (slide == 1) {
                var data = slideData.ESP.data;
                renderTitle(svg,'Spain',margin,width);
            } else if(slide == 2) {
                var data = slideData.USA.data;
                renderTitle(svg,'United States',margin,width);
            } else if(slide == 3) {
                var data = slideData.KOR.data;
                renderTitle(svg,'South Korea',margin,width);
            }

            svg.append('g').attr('transform', `translate(${margin},${margin})`)
                    .selectAll('circle').data(data).enter().append('circle')
                    .attr('cx', (d,i)=>{return x(new Date(d.date));})
                    .attr('cy', (d,i)=>{return y(d.total_cases_per_million)}) //max 14102
                    .attr('r', (d,i)=>{return 1 + d.new_cases_per_million / 40}) //max 237
                    .attr('fill', (d,i)=>{return colors(d.new_cases_per_million)})
                    .on('mouseover', (d,i)=>{
                        svg.append('text')
                            .attr('x', x(new Date(d.date) + margin))
                            .attr('y', y(d.total_cases_per_million))
                            .attr('id', 'hoverlabel0'+i)
                            .text(`Total cases per million: ${d.total_cases_per_million}`);
                        svg.append('text')
                            .attr('x', x(new Date(d.date)))
                            .attr('y', y(d.total_cases_per_million)+14)
                            .attr('id', 'hoverlabel1'+i)
                            .text(`New cases per million: ${d.new_cases_per_million}`);
                    })
                    .on('mouseout', (d,i)=>{
                        svg.select('#hoverlabel0'+i).remove();
                        svg.select('#hoverlabel1'+i).remove();
                    });
            svg.append('g')
                .attr('transform', `translate(${margin},${margin})`)
                .call(d3.axisLeft(y));
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x",0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Total Cases Per Million");
            svg.append('g')
                .attr('transform', `translate(${margin},${height-margin})`)
                .call(d3.axisBottom(x));
            svg.append('text')
                .attr('transform', `translate(${width/2},${height-margin+(margin/2)})`)
                .style('text-anchor', 'middle')
                .text('Date');

            function renderTitle(svg,title,margin,width) {
                svg.append("text")
                    .attr("x", (width / 2))             
                    .attr("y", 0)
                    .attr("text-anchor", "middle")  
                    .style("font-size", "16px") 
                    .style("text-decoration", "underline")  
                    .text(title);
            }
            
        }
        function next() {
            document.getElementById(`${currentSlide}`).removeAttribute('style');
            currentSlide += 1;
            if(currentSlide > 3) currentSlide = 1;
            render(currentSlide);
        }
        async function getData() {
            console.log('getData');
            var data = await d3.json('https://out0mana.github.io/owid-covid-data.json');
            gotData = true;
            console.log(data);
            slideData.ESP = data.ESP; //spain
            slideData.USA = data.USA; //usa
            slideData.KOR = data.KOR; //korea
            render(1);
            
        }
        
    </script>
    <head>
        <h2>Difference in COVID-19 Responses in different countries.</h2>
        <button id="1" onclick="render(1)">1</button>
        <button id="2" onclick="render(2)">2</button>
        <button id="3" onclick="render(3)">3</button>
        <button onclick="next()">Next</button>
        <br>
    </head>
    <body onload="getData()">
        <div></div>
    </body>
</html>